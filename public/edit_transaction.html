<!DOCTYPE html>
<html>
<head>
  <title>Edit Transaction</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #1976d2;
      border-bottom: 2px solid #1976d2;
      padding-bottom: 10px;
    }
    .form-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: inline-block;
      width: 150px;
      color: #424242;
      font-weight: bold;
    }
    input, select, textarea {
      width: calc(100% - 160px);
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    textarea {
      vertical-align: top;
      resize: vertical;
    }
    button {
      background-color: #1976d2;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #1565c0;
    }
    .delete-button {
      background-color: #d32f2f;
    }
    .delete-button:hover {
      background-color: #b71c1c;
    }
    .error-message {
      color: #d32f2f;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <h1 id="title">Edit Transaction</h1>
  <div class="form-container">
    <div class="form-group">
      <label for="from_account">From Account:</label>
      <input type="text" id="from_account" name="from_account">
    </div>
    <div class="form-group">
      <label for="to_account">To Account:</label>
      <input type="text" id="to_account" name="to_account">
    </div>
    <div class="form-group">
      <label for="amount">Amount (THB):</label>
      <input type="number" id="amount" name="amount">
    </div>
    <div class="form-group">
      <label for="type">Type:</label>
      <select id="type" name="type">
        <option value="transfer">Transfer</option>
        <option value="deposit">Deposit</option>
        <option value="withdraw">Withdraw</option>
      </select>
    </div>
    <div class="form-group">
      <label for="category">Category:</label>
      <input type="text" id="category" name="category">
    </div>
    <div class="form-group">
      <label for="comment">Comment:</label>
      <textarea id="comment" name="comment" rows="4"></textarea>
    </div>
    <button onclick="submitForm()">Save Changes</button>
    <button class="delete-button" onclick="deleteTransaction()">Delete Transaction</button>
    <p id="error-message" class="error-message"></p>
  </div>
  <button><a href="/transactions">Back to Transactions</a></button>
  <script>
    // ดึง transaction ID จาก URL
    const id = window.location.pathname.split('/')[2];
    
    // โหลดข้อมูล transaction เพื่อเติมในฟอร์ม
    fetch(`/api/transactions/${id}`)
      .then(response => {
        if (!response.ok) throw new Error('Transaction not found');
        return response.json();
      })
      .then(data => {
        document.getElementById('title').textContent = `Edit Transaction #${id}`;
        document.getElementById('from_account').value = data.transaction.from_account;
        document.getElementById('to_account').value = data.transaction.to_account;
        document.getElementById('amount').value = data.transaction.amount;
        document.getElementById('type').value = data.transaction.type;
        document.getElementById('category').value = data.transaction.category;
        document.getElementById('comment').value = data.transaction.comment;
      })
      .catch(error => {
        window.location.href = `/error.html?message=${encodeURIComponent(error.message)}&status=404`;
      });

    // ส่งข้อมูลฟอร์ม
    function submitForm() {
      const data = {
        from_account: document.getElementById('from_account').value,
        to_account: document.getElementById('to_account').value,
        amount: parseFloat(document.getElementById('amount').value),
        type: document.getElementById('type').value,
        category: document.getElementById('category').value,
        comment: document.getElementById('comment').value
      };
      fetch(`/api/transactions/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(response => {
          if (!response.ok) return response.json().then(err => { throw new Error(err.error); });
          return response.json();
        })
        .then(result => {
          alert(result.message);
          window.location.href = `/transactions/${id}`;
        })
        .catch(error => {
          const errorMessage = document.getElementById('error-message');
          errorMessage.textContent = error.message;
          errorMessage.style.display = 'block';
        });
    }

    // ลบ transaction
    function deleteTransaction() {
      if (!confirm('Are you sure you want to delete this transaction?')) return;
      fetch(`/api/transactions/${id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(response => {
          if (!response.ok) return response.json().then(err => { throw new Error(err.error); });
          return response.json();
        })
        .then(result => {
          alert(result.message);
          window.location.href = '/transactions'; // Redirect ไปหน้ารายการ transactions
        })
        .catch(error => {
          const errorMessage = document.getElementById('error-message');
          errorMessage.textContent = error.message;
          errorMessage.style.display = 'block';
        });
    }
  </script>
</body>
</html>